import requests
from telegram import Update
from telegram.ext import ApplicationBuilder, ContextTypes, MessageHandler, filters

TELEGRAM_BOT_TOKEN = "7233735648:AAFxxZdfU1VHIFAIFhf2MQLw_v_XZEWRSJ0"
WEBUI_API_URL = "http://<IP_СЕРВЕРА>:5000/api/v1/generate"

def generate_response(prompt):
    request = {
        "prompt": prompt,
        "temperature": 0.8,
        "max_length": 2048,
        "top_p": 0.9,
        "repetition_penalty": 1.1
    }
    try:
        response = requests.post(WEBUI_API_URL, json=request)
        if response.status_code == 200:
            return response.json()["results"][0]["text"].strip()
        else:
            return "[Ошибка]"
    except Exception as e:
        return f"[Ошибка: {e}]"

async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_input = update.message.text
    reply = generate_response(user_input)
    await update.message.reply_text(reply)

if __name__ == "__main__":
    app = ApplicationBuilder().token(TELEGRAM_BOT_TOKEN).build()
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))
    print("[+] Бот запущен. Ожидаем сообщений.")
    app.run_polling()
